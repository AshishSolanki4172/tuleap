#!/usr/bin/env groovy

def actions

pipeline {
    agent {
        label 'docker'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Scan') {
            agent {
                dockerfile {
                    dir 'sources/tools/utils/nix/'
                    filename 'tools.dockerfile'
                    reuseNode true
                    additionalBuildArgs '--build-arg TOOLS_REQUIRED=dev'
                    args '--read-only'
                }
            }
            steps {
                dir ('sources') {
                    sh """
                    make scan-vuln-deps
                    """
                }
            }
        }
    }

    post {
        failure {
            withCredentials([string(credentialsId: 'email-notification-rd-team', variable: 'email')]) {
                mail to: email,
                subject: "${currentBuild.fullDisplayName} is broken",
                body: "See ${env.BUILD_URL}"
            }
        }
        unstable {
            withCredentials([string(credentialsId: 'email-notification-rd-team', variable: 'email')]) {
                mail to: email,
                subject: "${currentBuild.fullDisplayName} is unstable",
                body: "See ${env.BUILD_URL}"
            }
        }
    }
}
