version: "2"

services:
  tuleap:
    image: ${DOCKER_REGISTRY:-docker.io}/tuleap/tuleap-community-edition:latest
    command: [ "--do-not-install-all-plugins", "--exec", "/usr/share/tuleap/tests/e2e/full/tuleap/setup.sh" ]
    environment:
      - TULEAP_FQDN=tuleap
      - DB_ADMIN_USER=root
      - DB_ADMIN_PASSWORD=welcome0
      - TULEAP_SYS_DBHOST=${DB_HOST}
      - TULEAP_SYS_DBPASSWD=welcome0
      - SITE_ADMINISTRATOR_PASSWORD=welcome0
      - TULEAP_EMAIL_TRANSPORT=smtp
      - TULEAP_EMAIL_RELAYHOST=mailhog:1025
      - TULEAP_FPM_SESSION_MODE=redis
      - TULEAP_REDIS_SERVER=redis
      - TULEAP_SRC=/usr/share/tuleap
    volumes:
      - .:/usr/share/tuleap:ro
    networks:
      - tuleap
    depends_on:
      - mailhog
      - redis

  mailhog:
    image: ${DOCKER_REGISTRY:-docker.io}/mailhog/mailhog:v1.0.1
    networks:
      - tuleap

  redis:
    image: ${DOCKER_REGISTRY:-docker.io}/redis:7.0.2-alpine
    networks:
      - tuleap

  test-cypress:
    image: tuleap-run-e2e-tests-cypress
    build:
      context: ./tests/e2e/docker # This is resolved from the root of the sources
      dockerfile: run-tests.dockerfile
      platforms:
        - linux/amd64
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY:-docker.io}
        CYPRESS_VERSION: $CYPRESS_VERSION
    command: /tuleap/tests/e2e/full/run.sh
    shm_size: 512M
    volumes:
      - .:/tuleap
      - ${TEST_RESULT_OUTPUT}:/output
    networks:
      - tuleap
      - external-connectivity

  test-phpunit:
    image: tuleap-run-e2e-tests-phpunit
    build:
      context: ./tests/e2e/docker
      dockerfile: run-phpunit-tests.dockerfile
      platforms:
        - linux/amd64
      args:
        DOCKER_REGISTRY: ${DOCKER_REGISTRY:-docker.io}
    command: /tuleap/tests/e2e/full/run-phpunit.sh
    volumes:
      - .:/tuleap
      - ${TEST_RESULT_OUTPUT}:/output
    networks:
      - tuleap

networks:
  tuleap:
    internal: true
  external-connectivity:
